#!/usr/bin/env bash

set -u

cd "$(dirname $0)"/..

STATE_FILE="${HOME}/.tool-install"

if [[ ! -f "$STATE_FILE" ]]; then
	touch "$STATE_FILE"
fi

is_installed() {
	local topic="$1"
	grep -Fxq "$topic" "$STATE_FILE"
}

record_installed() {
	local topic="$1"
	if ! is_installed "$topic"; then
		printf '%s\n' "$topic" >> "$STATE_FILE"
	fi
}

confirm() {
	local prompt="$1"
	local reply
	while true; do
		read -r -p "$prompt (Y/N): " reply
		case "$reply" in
			[Yy]) return 0 ;;
			[Nn]) return 1 ;;
			*) echo "Please answer Y or N." ;;
		esac
	done
}

echo "=== Topic installer ==="
echo "State file: $STATE_FILE"
echo

shopt -s nullglob
for dir in */ ; do
	[[ "$dir" == "script/" ]] && continue
	[[ ! -d "$dir" ]] && continue

	topic="${dir%/}"
	installer_path="${dir}install.sh"

	echo "Topic: ${topic}"

	if [[ ! -f "$installer_path" ]]; then
		echo "  ðŸš« Skip: no install.sh"
		continue
	fi

	if [[ -f "${dir}support.sh" ]]; then
		bash "${dir}support.sh"
		if [[ $? -ne 0 ]]; then
			echo "  ðŸš« Skip: not supported"
			continue
		fi
	fi

	if is_installed "$topic"; then
		if confirm "  '$topic' already installed. Reinstall?"; then
			echo "  â†’ Running $installer_path"
			bash "$installer_path"
			record_installed "$topic"
			echo "  âœ“ Reinstalled '$topic'"
		else
			echo "  ðŸš« Skip"
		fi
	else
		if confirm "  Install '$topic'?"; then
			echo "  â†’ Running $installer_path"
			bash "$installer_path"
			record_installed "$topic"
			echo "  âœ“ Installed '$topic'"
		else
			echo "  ðŸš« Skip"
		fi
	fi

	echo
done

echo "âœ“ All topics done."
